name: Reset Seats Scheduler

on:
  schedule:
    # 毎日21時0分に実行（UTC 12:00）
    - cron: "0 10 * * *"
  # 手動実行用のトリガー
  workflow_dispatch:

jobs:
  reset-seats:
    runs-on: ubuntu-latest
    steps:
      - name: Debug environment
        run: |
          echo "API Endpoint: ${{ secrets.RESET_API_ENDPOINT }}"
          echo "API Key length: ${#RESET_API_KEY}"
          # APIキーがBase64形式かを確認
          if [[ "${{ secrets.RESET_API_KEY }}" =~ ^[A-Za-z0-9+/=]+$ ]]; then
            echo "API Key format: Valid Base64 format"
          else
            echo "API Key format: Not in Base64 format"
          fi

      - name: Reset seats data
        run: |
          echo "リセットAPIを呼び出します..."
          RESPONSE=$(curl -s -X POST "${{ secrets.RESET_API_ENDPOINT }}" \
            -H "Content-Type: application/json" \
            -d "{\"authorization\": \"${{ secrets.RESET_API_KEY }}\"}")
          echo "API Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q "\"success\":true"; then
            echo "✅ 座席リセットが完了しました"
            exit 0
          else
            echo "❌ 座席リセットに失敗しました"
            echo "エラーの詳細: $RESPONSE"
            exit 1
          fi
