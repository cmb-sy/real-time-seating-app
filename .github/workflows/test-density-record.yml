name: Test Density Recording

on:
  workflow_dispatch:

jobs:
  test-density-record:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Test density recording
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ§ª å¯†åº¦è¨˜éŒ²æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹..."

          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: Supabaseèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… Supabaseèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          echo "URL: ${SUPABASE_URL}"

          # åº§å¸­ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ†ã‚¹ãƒˆ
          echo "ğŸ“Š åº§å¸­ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­..."
          SEATS_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X GET \
            "${SUPABASE_URL}/rest/v1/seats?select=*" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          HTTP_CODE=$(echo "$SEATS_RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$SEATS_RESPONSE" | sed '/HTTP_CODE/d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… åº§å¸­ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ"
            echo "ãƒ‡ãƒ¼ã‚¿: $RESPONSE_BODY"
          else
            echo "âŒ åº§å¸­ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

          # å¯†åº¦è¨ˆç®—
          OCCUPIED_COUNT=$(echo "$RESPONSE_BODY" | jq '[.[] | select(.is_occupied == true)] | length')
          # ç·åº§å¸­æ•°ã¯8å¸­å›ºå®š
          TOTAL_SEATS=8
          DENSITY_RATE=$(echo "scale=2; $OCCUPIED_COUNT * 100 / $TOTAL_SEATS" | bc)

          echo "å æœ‰åº§å¸­æ•°: $OCCUPIED_COUNT / $TOTAL_SEATS"
          echo "å¯†åº¦ç‡: $DENSITY_RATE%"

          # settings ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ãƒ†ã‚¹ãƒˆ
          echo "âš™ï¸ è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ä¸­..."
          SETTINGS_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PATCH \
            "${SUPABASE_URL}/rest/v1/settings?key=eq.density" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"value\": $DENSITY_RATE}")

          HTTP_CODE=$(echo "$SETTINGS_RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$SETTINGS_RESPONSE" | sed '/HTTP_CODE/d')

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°å¤±æ•—"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
          fi

          # density_history ãƒ†ãƒ¼ãƒ–ãƒ«æŒ¿å…¥ãƒ†ã‚¹ãƒˆ
          echo "ğŸ“ˆ å¯†åº¦å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ä¸­..."
          DAY_OF_WEEK=$(date +%w)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          HISTORY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "${SUPABASE_URL}/rest/v1/density_history" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"day_of_week\": $DAY_OF_WEEK,
              \"density_rate\": $DENSITY_RATE,
              \"occupied_seats\": $OCCUPIED_COUNT,
              \"created_at\": \"$TIMESTAMP\"
            }")

          HTTP_CODE=$(echo "$HISTORY_RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$HISTORY_RESPONSE" | sed '/HTTP_CODE/d')

          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… å¯†åº¦å±¥æ­´è¨˜éŒ²æˆåŠŸ"
            echo "è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿: $RESPONSE_BODY"
          else
            echo "âŒ å¯†åº¦å±¥æ­´è¨˜éŒ²å¤±æ•—"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            
            # ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’èª¿æŸ»
            echo "ğŸ” ã‚¨ãƒ©ãƒ¼è©³ç´°èª¿æŸ»..."
            
            # ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèª
            TABLE_INFO=$(curl -s -X GET \
              "${SUPABASE_URL}/rest/v1/density_history?limit=1" \
              -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")
            echo "ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±: $TABLE_INFO"
          fi

          echo "ğŸ¯ ãƒ†ã‚¹ãƒˆå®Œäº†"
