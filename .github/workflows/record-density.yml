name: Record Density Data

on:
  schedule:
    # 平日の17:00に実行（UTC 8:00）
    - cron: "0 8 * * 1-5"
  # 手動実行用のトリガー
  workflow_dispatch:

jobs:
  record-density:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Record density data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # シークレットの存在確認
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "エラー: Supabase認証情報が設定されていません"
            exit 1
          fi

          # 現在の曜日を取得（0: 日曜日, 1: 月曜日, ..., 6: 土曜日）
          DAY_OF_WEEK=$(node -e "console.log(new Date().getDay())")

          # 占有席数を取得（正しいSupabaseクエリを使用）
          OCCUPIED_SEATS=$(curl -s \
            "${SUPABASE_URL}/rest/v1/seats?select=*&is_occupied=eq.true" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" | \
            jq 'length')

          # 密度率を取得
          DENSITY_RATE=$(curl -s \
            "${SUPABASE_URL}/rest/v1/settings?key=eq.density" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" | \
            jq -r '.[0].value // 0')

          echo "曜日: $DAY_OF_WEEK, 占有席数: $OCCUPIED_SEATS, 密度率: $DENSITY_RATE"

          # データ検証
          if ! [[ "$OCCUPIED_SEATS" =~ ^[0-9]+$ ]] || ! [[ "$DENSITY_RATE" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
            echo "エラー: データ形式が不正です"
            exit 1
          fi

          # データを記録（占有席数または密度率が0でない場合のみ）
          if [ "$OCCUPIED_SEATS" -gt 0 ] || [ "$(echo "$DENSITY_RATE > 0" | bc)" -eq 1 ]; then
            curl -s -X POST \
              "${SUPABASE_URL}/rest/v1/density_history" \
              -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"day_of_week\": $DAY_OF_WEEK,
                \"occupied_seats\": $OCCUPIED_SEATS,
                \"density_rate\": $DENSITY_RATE
              }"
            echo "データを記録しました: 占有席数=$OCCUPIED_SEATS, 密度率=$DENSITY_RATE"
          else
            echo "占有席数と密度率が共に0のため、記録をスキップしました"
          fi
