name: Record Density Scheduler

on:
  schedule:
    - cron: "0 8 * * *"
  # æ‰‹å‹•å®Ÿè¡Œç”¨ã®ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:

jobs:
  record-density:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Record density data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: Supabaseèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          echo "ğŸ“Š ç¾åœ¨ã®å¯†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ä¸­..."

          # ç¾åœ¨ã®åº§å¸­çŠ¶æ³ã‚’å–å¾—
          SEATS_RESPONSE=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/seats?select=*" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          echo "åº§å¸­ãƒ‡ãƒ¼ã‚¿: $SEATS_RESPONSE"

          # å æœ‰ã•ã‚Œã¦ã„ã‚‹åº§å¸­æ•°ã‚’è¨ˆç®—
          OCCUPIED_COUNT=$(echo "$SEATS_RESPONSE" | jq '[.[] | select(.is_occupied == true)] | length')

          # ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠã•ã‚ŒãŸç¤¾å†…äººå£å¯†åº¦ç‡ã‚’å–å¾—
          DENSITY_RESPONSE=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/settings?key=eq.density&select=value" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          DENSITY_RATE=$(echo "$DENSITY_RESPONSE" | jq -r '.[0].value // 0')

          echo "å æœ‰åº§å¸­æ•°: $OCCUPIED_COUNT"
          echo "ç¤¾å†…äººå£å¯†åº¦ç‡: $DENSITY_RATE%ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠå€¤ï¼‰"

          # ç¾åœ¨ã®æ›œæ—¥ã‚’å–å¾—ï¼ˆ0: æ—¥æ›œæ—¥, 1: æœˆæ›œæ—¥, ..., 6: åœŸæ›œæ—¥ï¼‰
          DAY_OF_WEEK=$(date +%w)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # å¯†åº¦å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²
          INSERT_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "${SUPABASE_URL}/rest/v1/density_history" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"day_of_week\": $DAY_OF_WEEK,
              \"density_rate\": $DENSITY_RATE,
              \"occupied_seats\": $OCCUPIED_COUNT,
              \"created_at\": \"$TIMESTAMP\"
            }")

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æ
          HTTP_CODE=$(echo "$INSERT_RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$INSERT_RESPONSE" | sed '/HTTP_CODE/d')

          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… å¯†åº¦å±¥æ­´ã®è¨˜éŒ²ãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ å¯†åº¦å±¥æ­´ã®è¨˜éŒ²ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
          fi

          echo "âœ… å¯†åº¦ãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆå¯†åº¦ç‡: ${DENSITY_RATE}%ï¼‰"
