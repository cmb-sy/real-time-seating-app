name: Record Density Data

on:
  schedule:
    # å¹³æ—¥ã®17:00ã«å®Ÿè¡Œï¼ˆUTC 8:00ï¼‰
    - cron: "0 8 * * 1-5"
  # æ‰‹å‹•å®Ÿè¡Œç”¨ã®ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:

jobs:
  record-density:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Record density data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
          echo "Supabase URL: ${{ secrets.SUPABASE_URL }}"
          echo "Service Role Key length: ${#SUPABASE_SERVICE_ROLE_KEY}"
          
          # ç¾åœ¨ã®æ›œæ—¥ã‚’å–å¾—ï¼ˆ0: æ—¥æ›œæ—¥, 1: æœˆæ›œæ—¥, ..., 6: åœŸæ›œæ—¥ï¼‰
          DAY_OF_WEEK=$(node -e "console.log(new Date().getDay())")
          echo "ğŸ“… æ›œæ—¥: $DAY_OF_WEEK"
          
          # å æœ‰å¸­æ•°ã‚’å–å¾—
          echo "ğŸª‘ å æœ‰å¸­æ•°ã‚’å–å¾—ä¸­..."
          OCCUPIED_SEATS_RESPONSE=$(curl -s -X GET \
            "${{ secrets.SUPABASE_URL }}/rest/v1/seats?select=count&is_occupied=eq.true" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: count=exact")
          echo "å æœ‰å¸­æ•°ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $OCCUPIED_SEATS_RESPONSE"
          OCCUPIED_SEATS=$(echo $OCCUPIED_SEATS_RESPONSE | jq -r '.count')
          echo "ğŸª‘ å æœ‰å¸­æ•°: $OCCUPIED_SEATS"
          
          # å¯†åº¦ç‡ã‚’å–å¾—
          echo "ğŸ“Š å¯†åº¦ç‡ã‚’å–å¾—ä¸­..."
          DENSITY_RATE_RESPONSE=$(curl -s -X GET \
            "${{ secrets.SUPABASE_URL }}/rest/v1/settings?key=eq.density" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation")
          echo "å¯†åº¦ç‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $DENSITY_RATE_RESPONSE"
          DENSITY_RATE=$(echo $DENSITY_RATE_RESPONSE | jq -r '.[0].value')
          echo "ğŸ“Š å¯†åº¦ç‡: $DENSITY_RATE"
          
          # ãƒ‡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿è¨˜éŒ²
          if [ "$OCCUPIED_SEATS" -gt 0 ] && [ "$DENSITY_RATE" != "0" ]; then
            echo "ğŸ“ è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã™..."
            
            # ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
            RECORD_RESPONSE=$(curl -s -X POST \
              "${{ secrets.SUPABASE_URL }}/rest/v1/density_history" \
              -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              -H "Content-Type: application/json" \
              -H "Prefer: return=representation" \
              -d "{
                \"day_of_week\": $DAY_OF_WEEK,
                \"occupied_seats\": $OCCUPIED_SEATS,
                \"density_rate\": $DENSITY_RATE
              }")
            echo "è¨˜éŒ²ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $RECORD_RESPONSE"
            
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ è¨˜éŒ²æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“"
            echo "å æœ‰å¸­æ•°: $OCCUPIED_SEATS"
            echo "å¯†åº¦ç‡: $DENSITY_RATE"
          fi 