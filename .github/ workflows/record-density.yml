name: Record Density Scheduler

on:
  schedule:
    # æ¯æ™‚é–“å®Ÿè¡Œï¼ˆå¯†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ï¼‰
    - cron: "0 * * * *"
  # æ‰‹å‹•å®Ÿè¡Œç”¨ã®ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:

jobs:
  record-density:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Record density data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: Supabaseèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          echo "ğŸ“Š ç¾åœ¨ã®å¯†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ä¸­..."

          # ç¾åœ¨ã®åº§å¸­çŠ¶æ³ã‚’å–å¾—
          SEATS_RESPONSE=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/seats?select=*" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          echo "åº§å¸­ãƒ‡ãƒ¼ã‚¿: $SEATS_RESPONSE"

          # å æœ‰ã•ã‚Œã¦ã„ã‚‹åº§å¸­æ•°ã‚’è¨ˆç®—
          OCCUPIED_COUNT=$(echo "$SEATS_RESPONSE" | jq '[.[] | select(.is_occupied == true)] | length')
          TOTAL_SEATS=8
          DENSITY_RATE=$(echo "scale=2; $OCCUPIED_COUNT * 100 / $TOTAL_SEATS" | bc)

          echo "å æœ‰åº§å¸­æ•°: $OCCUPIED_COUNT / $TOTAL_SEATS"
          echo "å¯†åº¦ç‡: $DENSITY_RATE%"

          # ç¾åœ¨ã®å¯†åº¦ç‡ã‚’è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
          curl -s -X PATCH \
            "${SUPABASE_URL}/rest/v1/settings?key=eq.density" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"value\": $DENSITY_RATE}"

          # å¯†åº¦å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -s -X POST \
            "${SUPABASE_URL}/rest/v1/density_history" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"density_rate\": $DENSITY_RATE,
              \"occupied_seats\": $OCCUPIED_COUNT,  
              \"total_seats\": $TOTAL_SEATS,
              \"recorded_at\": \"$TIMESTAMP\"
            }" || echo "å¯†åº¦å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"

          echo "âœ… å¯†åº¦ãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆå¯†åº¦ç‡: ${DENSITY_RATE}%ï¼‰"
